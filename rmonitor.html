<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ESP32 Control Panel â€” Dark/Light</title>
<script src="https://cdn.tailwindcss.com"></script>
<script>
  // Theme helper
  function applyTheme(mode){
    document.documentElement.classList.remove('dark');
    if(mode === 'dark') document.documentElement.classList.add('dark');
    localStorage.setItem('theme', mode);
    const chk = document.getElementById('themeSwitch'); if(chk) chk.checked = mode === 'dark';
  }
  document.addEventListener('DOMContentLoaded', ()=>{
    const saved = localStorage.getItem('theme') || 'dark';
    applyTheme(saved);
  });
</script>
<style>
  :root{ --bg:#0b1220; --card:#0f1720; --muted:#94a3b8; --accent:#00c2a8; }
  .flash-red{ animation: flashRed 1s linear infinite; }
  @keyframes flashRed{ 0%{ box-shadow:0 0 0 rgba(255,68,68,0.0);}50%{ box-shadow:0 0 12px rgba(255,68,68,0.35);}100%{box-shadow:0 0 0 rgba(255,68,68,0);} }
  .vertical-bar { width:18px; height:140px; border-radius:8px; background:linear-gradient(to top,#ef4444,#f97316,#10b981); display:flex; align-items:flex-end; overflow:hidden }
  .vertical-fill{ width:100%; background:currentColor; transition:height 400ms ease; }
  /* compact card sizes */
  .card-small{ padding:12px; border-radius:10px; }
  /* simple switch visuals */
  .switch { position: relative; display: inline-block; width: 46px; height: 24px; }
  .switch input { opacity: 0; width: 0; height: 0; }
  .switch .slider { position: absolute; cursor: pointer; inset: 0; background: #cbd5e1; border-radius: 9999px; }
  .switch .dot { position: absolute; left:4px; top:4px; width:16px; height:16px; background:white; border-radius:9999px; transition: transform .2s; }
  .switch input:checked + .slider { background: #10b981; }
  .switch input:checked + .slider + .dot { transform: translateX(22px); }
</style>
</head>
<body class="dark:bg-gray-900 bg-gray-50 min-h-screen text-gray-100 dark:text-gray-100 p-6">
  <div class="max-w-4xl mx-auto">
    <header class="flex items-center justify-between mb-4">
      <div>
        <h1 class="text-2xl font-bold">ESP32 Reloading Monitor</h1>
        <div id="deviceName" class="text-sm text-gray-400">No device</div>
      </div>

      <div class="flex items-center gap-3">
        <div class="flex items-center gap-2">
          <label class="text-sm text-gray-300">Dark</label>
          <label class="switch inline-block">
            <input id="themeSwitch" type="checkbox" onchange="applyTheme(this.checked?'dark':'light')">
            <span class="slider"></span>
            <span class="dot"></span>
          </label>
        </div>
        <button id="connectBtn" class="px-3 py-2 bg-accent text-black font-semibold rounded">Connect BLE</button>
      </div>
    </header>

    <!-- Tabs -->
    <nav class="mb-4">
      <button id="tab-dashboard" class="px-3 py-2 bg-transparent border-b-2 border-accent text-accent">Dashboard</button>
      <button id="tab-settings" class="px-3 py-2 ml-2 text-sm text-gray-400">Settings</button>
    </nav>

    <!-- Dashboard view -->
    <section id="view-dashboard">
      <!-- two-row compact grid -->
      <div class="grid grid-cols-4 gap-4 mb-4">
        <!-- Completed Rounds (small) -->
        <div id="roundsCard" class="card-small bg-white dark:bg-gray-800 text-black dark:text-white shadow col-span-1">
          <div class="text-sm text-gray-500 dark:text-gray-300">Rounds</div>
          <div id="round-count" class="text-2xl font-bold mt-2">0</div>
        </div>

        <!-- Primers -->
        <div id="card-primers" class="card-small bg-white dark:bg-gray-800 shadow col-span-1">
          <div class="text-sm text-gray-400">Primers</div>
          <div id="primers-status" class="text-lg font-semibold mt-2 text-green-500">OK</div>
        </div>

        <!-- Cases -->
        <div id="card-cases" class="card-small bg-white dark:bg-gray-800 shadow col-span-1">
          <div class="text-sm text-gray-400">Cases</div>
          <div id="cases-status" class="text-lg font-semibold mt-2 text-green-500">OK</div>
        </div>

        <!-- Bullets -->
        <div id="card-bullets" class="card-small bg-white dark:bg-gray-800 shadow col-span-1">
          <div class="text-sm text-gray-400">Bullets</div>
          <div id="bullets-status" class="text-lg font-semibold mt-2 text-green-500">OK</div>
        </div>
      </div>

      <!-- Row 2: Powder and placeholders -->
      <div class="grid grid-cols-4 gap-4">
        <!-- Powder with vertical bar (col span 1) -->
        <div class="col-span-1 flex items-center justify-center p-3 bg-white dark:bg-gray-800 shadow rounded">
          <div class="flex flex-col items-center gap-3">
            <div class="text-sm text-gray-400">Powder</div>
            <div class="vertical-bar" aria-hidden>
              <div id="powder-fill" class="vertical-fill" style="height:100%; background:linear-gradient(to top,#10b981,#f97316,#ef4444);"></div>
            </div>
            <div id="powder-percent" class="text-sm text-gray-300">100%</div>
          </div>
        </div>

        <!-- Sensors placeholder (col-span 3) -->
        <div class="col-span-3 grid grid-cols-3 gap-4">
          <div id="sensor-extra-1" class="p-3 bg-white dark:bg-gray-800 shadow rounded text-center">Sensor A</div>
          <div id="sensor-extra-2" class="p-3 bg-white dark:bg-gray-800 shadow rounded text-center">Sensor B</div>
          <div id="sensor-extra-3" class="p-3 bg-white dark:bg-gray-800 shadow rounded text-center">Sensor C</div>
        </div>
      </div>

      <!-- Emergency Stop area (only shown when motor enabled) -->
      <div id="estopArea" class="mt-4 hidden">
        <div id="estopCard" class="p-3 bg-red-700 text-white rounded shadow text-center font-bold">EMERGENCY STOP ACTIVATED</div>
      </div>
    </section>

    <!-- Settings view -->
    <section id="view-settings" class="hidden">
      <div class="grid grid-cols-2 gap-4">
        <div class="p-4 bg-white dark:bg-gray-800 rounded shadow">
          <h3 class="font-semibold mb-2">Toggles</h3>
          <div class="flex items-center justify-between mb-2">
            <div>Motor Enabled</div>
            <input id="motorEnable" type="checkbox">
          </div>
          <div class="flex items-center justify-between mb-2">
            <div>Primers Sensor</div>
            <input id="primersEnable" type="checkbox" checked>
          </div>
          <div class="flex items-center justify-between mb-2">
            <div>Cases Sensor</div>
            <input id="casesEnable" type="checkbox" checked>
          </div>
          <div class="flex items-center justify-between mb-2">
            <div>Bullets Sensor</div>
            <input id="bulletsEnable" type="checkbox" checked>
          </div>
        </div>

        <div class="p-4 bg-white dark:bg-gray-800 rounded shadow">
          <h3 class="font-semibold mb-2">Logs</h3>
          <pre id="log" class="h-64 overflow-auto text-sm bg-gray-100 dark:bg-gray-900 p-2 rounded text-gray-900 dark:text-gray-100"></pre>
        </div>
      </div>
    </section>

  </div>

<script>
// tiny helper
const $ = (id)=>document.getElementById(id);
function L(s){ const log=$('log'); if(log){ log.textContent += s + "
"; log.scrollTop = log.scrollHeight; } console.log(s); }

// BLE state
let bleDevice=null, gattServer=null, notifyChar=null;
const SERVICE = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
const NOTIFY_CHAR = '6e400002-b5a3-f393-e0a9-e50e24dcca9e';

async function connectBLE(){
  try{
    L('Requesting device...');
    bleDevice = await navigator.bluetooth.requestDevice({ filters:[{services:[SERVICE]}], optionalServices:[SERVICE] });
    $('deviceName').textContent = bleDevice.name || bleDevice.id;
    bleDevice.addEventListener('gattserverdisconnected', onDisconnected);

    L('Connecting GATT...');
    gattServer = await bleDevice.gatt.connect();
    L('Connected');

    const service = await gattServer.getPrimaryService(SERVICE);
    notifyChar = await service.getCharacteristic(NOTIFY_CHAR);
    await notifyChar.startNotifications();
    notifyChar.addEventListener('characteristicvaluechanged', handleNotify);

    $('connState').textContent = 'Connected';
    $('connectBtn').textContent = 'Connected';
    $('connectBtn').disabled = true;
    $('disconnectBtn') && ($('disconnectBtn').disabled = false);

  } catch(e){ L('BLE error: ' + e); }
}
function onDisconnected(){ L('Device disconnected'); $('connState').textContent = 'Disconnected'; $('connectBtn').disabled = false; }
$('connectBtn').addEventListener('click', connectBLE);

// Tab handling
$('tab-dashboard').addEventListener('click', ()=>{ $('view-dashboard').classList.remove('hidden'); $('view-settings').classList.add('hidden'); $('tab-dashboard').classList.add('text-accent'); $('tab-settings').classList.remove('text-accent'); });
$('tab-settings').addEventListener('click', ()=>{ $('view-dashboard').classList.add('hidden'); $('view-settings').classList.remove('hidden'); $('tab-dashboard').classList.remove('text-accent'); $('tab-settings').classList.add('text-accent'); });

// Toggle behavior & rendering
function renderSensors(){
  const primersOn = $('primersEnable').checked;
  const casesOn = $('casesEnable').checked;
  const bulletsOn = $('bulletsEnable').checked;
  $('card-primers').style.display = primersOn ? 'block' : 'none';
  $('card-cases').style.display = casesOn ? 'block' : 'none';
  $('card-bullets').style.display = bulletsOn ? 'block' : 'none';
}
$('primersEnable').addEventListener('change', renderSensors);
$('casesEnable').addEventListener('change', renderSensors);
$('bulletsEnable').addEventListener('change', renderSensors);
$('motorEnable').addEventListener('change', ()=>{ const on=$('motorEnable').checked; $('estopArea').classList.toggle('hidden', !on); });

// initial render
renderSensors(); $('estopArea').classList.add('hidden');

// Update helpers
function setRoundsCount(n){ $('round-count').textContent = n; }
function setPowderPercent(p){ const pct = Math.max(-1, Math.min(100, Math.floor(p))); if(pct < 0){ $('powder-fill').style.height = '100%'; $('powder-percent').textContent = 'ERR'; $('powder-fill').style.background = 'linear-gradient(to top,#ef4444,#f97316)'; return; } const h = pct + '%'; $('powder-fill').style.height = h; $('powder-percent').textContent = pct + '%'; if(pct <= 10){ $('powder-fill').classList.add('flash-red'); } else { $('powder-fill').classList.remove('flash-red'); } }

function setSupplyStatus(id, ok){ const el = (""+id+"-status") ? $(""+id+"-status") : null; const card = $("card-"+id); if(!el) return; if(ok){ el.textContent = 'OK'; el.classList.remove('text-red-400'); el.classList.add('text-green-500'); card.classList.remove('flash-red'); card.style.background = ''; } else { el.textContent = 'EMPTY'; el.classList.remove('text-green-500'); el.classList.add('text-red-400'); card.classList.add('flash-red'); card.style.background = '#3b0b0b'; } }

// Handle incoming notification payload like: "PDR=-1,PMR=1,CAS=1,BLT=1,CNT=0,MOT_EN=0,MOT_RUN=0,MOT_DIR=1,ESTOP=0"
function handleNotify(ev){
  try{
    const dv = ev.target.value; // DataView
    const arr = new Uint8Array(dv.buffer, dv.byteOffset, dv.byteLength);
    const txt = new TextDecoder().decode(arr);
    L('RX: ' + txt);
    const parts = txt.split(',');
    const obj = {};
    parts.forEach(p=>{ const kv = p.split('='); if(kv.length===2) obj[kv[0].trim()] = kv[1].trim(); });

    // Powder PDR can be -1 for error or 0..100
    const pdr = parseInt(obj['PDR']); setPowderPercent(isNaN(pdr)? -1 : pdr);

    // Supplies PMR, CAS, BLT: 1=OK, 0=EMPTY
    setSupplyStatus('primers', obj['PMR'] === '1');
    setSupplyStatus('cases', obj['CAS'] === '1');
    setSupplyStatus('bullets', obj['BLT'] === '1');

    // Rounds
    const cnt = parseInt(obj['CNT']); setRoundsCount(isNaN(cnt)? 0 : cnt);

    // Motor & ESTOP
    const mot = obj['MOT_EN'] === '1';
    $('motorEnable').checked = mot;
    $('estopArea').classList.toggle('hidden', !mot);
    const est = obj['ESTOP'] === '1';
    if(est && mot){ $('estopCard').classList.remove('hidden'); } else { $('estopCard').classList.add('hidden'); }

  }catch(e){ L('Notify parse error ' + e); }
}

</script>
</body>
</html>
