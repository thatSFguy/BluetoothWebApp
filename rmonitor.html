<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reloading Monitor Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Dark background */
        }
        /* Custom utility for status colors */
        .status-card {
            transition: all 0.3s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        /* Pulse animation for 'In Alarm' */
        .alarm-pulse {
            animation: pulse-red 1.5s infinite;
        }
        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 69, 58, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(255, 69, 58, 0); }
        }
        /* CSS for the Motor status indicator */
        .motor-running {
            box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7);
            animation: pulse-green 2s infinite;
        }
        .motor-reverse {
            box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.7);
            animation: pulse-yellow 2s infinite;
        }
        @keyframes pulse-green {
            0%, 100% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); }
            50% { box-shadow: 0 0 0 8px rgba(74, 222, 128, 0); }
        }
        @keyframes pulse-yellow {
            0%, 100% { box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.7); }
            50% { box-shadow: 0 0 0 8px rgba(251, 191, 36, 0); }
        }

    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <h1 class="text-4xl font-extrabold text-white mb-2 tracking-tight">
            Reloading Monitor Dashboard
        </h1>
        <p class="text-gray-400 mb-8">Real-time status via Bluetooth Low Energy (BLE)</p>

        <!-- Connection and Status Panel -->
        <div class="bg-gray-800 p-6 rounded-xl shadow-lg mb-8 flex flex-col md:flex-row items-center justify-between">
            <div class="flex items-center space-x-4 mb-4 md:mb-0">
                <span id="connectionStatusIcon" class="inline-block h-4 w-4 rounded-full bg-red-500"></span>
                <span id="connectionStatusText" class="text-lg font-semibold text-red-400">Disconnected</span>
            </div>
            <button id="connectButton" 
                    class="w-full md:w-auto px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg transition-colors duration-200 shadow-md">
                Connect to ESP32
            </button>
        </div>

        <!-- Data Display Grid -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <!-- Total Count -->
            <div class="status-card bg-gray-700 p-4 rounded-xl text-center">
                <p class="text-sm font-medium text-gray-400 uppercase">Total Rounds</p>
                <p id="totalCount" class="text-4xl font-extrabold text-indigo-400 mt-1">--</p>
            </div>

            <!-- Powder Percentage -->
            <div id="powderCard" class="status-card bg-gray-700 p-4 rounded-xl text-center">
                <p class="text-sm font-medium text-gray-400 uppercase">Powder %</p>
                <p id="powderPct" class="text-4xl font-extrabold text-yellow-400 mt-1">--</p>
            </div>

            <!-- Motor Status -->
            <div class="status-card bg-gray-700 p-4 rounded-xl text-center">
                <p class="text-sm font-medium text-gray-400 uppercase">Motor Status</p>
                <div class="flex items-center justify-center mt-2 space-x-2">
                    <span id="motorIcon" class="h-3 w-3 rounded-full bg-gray-500 transition-all duration-300"></span>
                    <p id="motorStatus" class="text-xl font-bold text-gray-300">Idle</p>
                </div>
            </div>

            <!-- Health Status -->
            <div id="healthCard" class="status-card bg-gray-700 p-4 rounded-xl text-center">
                <p class="text-sm font-medium text-gray-400 uppercase">System Health</p>
                <p id="systemHealth" class="text-2xl font-bold text-green-400 mt-1">OK</p>
            </div>
        </div>

        <!-- Sensor Status Grid -->
        <h2 class="text-2xl font-semibold text-white mb-4">Material Status</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Primer Status -->
            <div id="primerCard" class="status-card bg-gray-700 p-6 rounded-xl flex items-center justify-between">
                <p class="text-xl font-semibold text-white">Primer Hopper</p>
                <span id="primerStatus" class="text-xl font-bold text-gray-300">--</span>
            </div>

            <!-- Case Status -->
            <div id="caseCard" class="status-card bg-gray-700 p-6 rounded-xl flex items-center justify-between">
                <p class="text-xl font-semibold text-white">Case Hopper</p>
                <span id="caseStatus" class="text-xl font-bold text-gray-300">--</span>
            </div>

            <!-- Bullet Status -->
            <div id="bulletCard" class="status-card bg-gray-700 p-6 rounded-xl flex items-center justify-between">
                <p class="text-xl font-semibold text-white">Bullet Feeder</p>
                <span id="bulletStatus" class="text-xl font-bold text-gray-300">--</span>
            </div>
        </div>

        <!-- Alert Log / Console -->
        <h2 class="text-2xl font-semibold text-white mt-8 mb-4">BLE Data Stream</h2>
        <div id="log" class="bg-gray-900 p-4 h-48 overflow-y-scroll rounded-xl text-sm text-gray-400 font-mono">
            Waiting for connection...
        </div>
    </div>

    <script>
        // --- BLE Configuration (MUST MATCH ESP32) ---
        // Nordic UART Service (NUS) UUID
        const SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
        const DATA_CHARACTERISTIC_UUID = '6e400003-b5a3-f393-e0a9-e50e24dcca9e';
        const DEVICE_NAME_PREFIX = 'ReloadMeister-'; // Name prefix used for discovery

        let device, dataCharacteristic;
        let isConnected = false;

        // --- DOM Elements ---
        const connectButton = document.getElementById('connectButton');
        const statusIcon = document.getElementById('connectionStatusIcon');
        const statusText = document.getElementById('connectionStatusText');
        const logElement = document.getElementById('log');

        const elements = {
            primerCard: document.getElementById('primerCard'),
            caseCard: document.getElementById('caseCard'),
            bulletCard: document.getElementById('bulletCard'),
            powderCard: document.getElementById('powderCard'),
            
            primerStatus: document.getElementById('primerStatus'),
            caseStatus: document.getElementById('caseStatus'),
            bulletStatus: document.getElementById('bulletStatus'),
            
            powderPct: document.getElementById('powderPct'),
            totalCount: document.getElementById('totalCount'),
            motorStatus: document.getElementById('motorStatus'),
            motorIcon: document.getElementById('motorIcon'),
            systemHealth: document.getElementById('systemHealth'),
            healthCard: document.getElementById('healthCard'),
        };

        // Utility to map status code to color/text
        function getStatus(code, name) {
            const isOK = code === 1;
            const text = isOK ? 'OK' : 'In Alarm';
            const colorClass = isOK ? 'bg-green-600 text-green-300' : 'bg-red-700 text-red-300 alarm-pulse';
            
            return {
                text: text,
                textColor: isOK ? 'text-green-400' : 'text-red-400',
                cardClasses: isOK ? 'bg-gray-700' : 'bg-red-900/50 alarm-pulse border border-red-500',
                alarm: !isOK,
                log: `[${name}] ${text}`
            };
        }

        // --- Logging ---
        function log(message, isError = false) {
            const time = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${time}] ${message}`;
            logEntry.className = isError ? 'text-red-400' : 'text-gray-400';
            logElement.prepend(logEntry); // Add to the top
            // Limit log size
            while (logElement.children.length > 50) {
                logElement.removeChild(logElement.lastChild);
            }
        }

        // --- Handle BLE Notification Data ---
        function handleData(event) {
            const value = event.target.value;
            const dataString = new TextDecoder().decode(value.buffer);
            log(`Raw Data: ${dataString}`);

            const parts = dataString.split(',');
            if (parts.length !== 6) {
                log('Error: Invalid data format received.', true);
                return;
            }

            const data = {};
            parts.forEach(part => {
                const [key, val] = part.split('=');
                data[key.trim()] = parseInt(val.trim(), 10);
            });

            // 1. Update Sensor Statuses (Pri, Cas, Bul)
            const primer = getStatus(data.Pri, 'Primer');
            const caseSt = getStatus(data.Cas, 'Case');
            const bullet = getStatus(data.Bul, 'Bullet');
            
            let systemInAlarm = primer.alarm || caseSt.alarm || bullet.alarm;

            elements.primerStatus.textContent = primer.text;
            elements.primerStatus.className = 'text-xl font-bold ' + primer.textColor;
            elements.primerCard.className = 'status-card p-6 rounded-xl flex items-center justify-between ' + primer.cardClasses;

            elements.caseStatus.textContent = caseSt.text;
            elements.caseStatus.className = 'text-xl font-bold ' + caseSt.textColor;
            elements.caseCard.className = 'status-card p-6 rounded-xl flex items-center justify-between ' + caseSt.cardClasses;

            elements.bulletStatus.textContent = bullet.text;
            elements.bulletStatus.className = 'text-xl font-bold ' + bullet.textColor;
            elements.bulletCard.className = 'status-card p-6 rounded-xl flex items-center justify-between ' + bullet.cardClasses;
            
            // 2. Update Total Count
            elements.totalCount.textContent = data.Cnt.toLocaleString();

            // 3. Update Powder Percentage
            const powderPct = data.Powder;
            elements.powderPct.textContent = `${powderPct}%`;

            if (powderPct < 5) {
                elements.powderCard.className = 'status-card p-4 rounded-xl text-center bg-red-900/50 alarm-pulse border border-red-500';
                systemInAlarm = true;
            } else if (powderPct < 20) {
                elements.powderCard.className = 'status-card p-4 rounded-xl text-center bg-yellow-900/50 border border-yellow-500';
            } else {
                elements.powderCard.className = 'status-card p-4 rounded-xl text-center bg-gray-700';
            }


            // 4. Update Motor Status (Mot)
            let motorText = '';
            let motorColor = 'bg-gray-500';
            let motorClasses = '';
            
            switch (data.Mot) {
                case 0:
                    motorText = 'Idle';
                    motorColor = 'bg-gray-500';
                    break;
                case 1:
                    motorText = 'Forward';
                    motorColor = 'bg-green-400';
                    motorClasses = 'motor-running';
                    break;
                case 2:
                    motorText = 'Reverse';
                    motorColor = 'bg-yellow-400';
                    motorClasses = 'motor-reverse';
                    break;
                default:
                    motorText = 'Unknown';
                    motorColor = 'bg-red-500';
                    break;
            }
            elements.motorStatus.textContent = motorText;
            elements.motorStatus.className = 'text-xl font-bold text-gray-300';
            elements.motorIcon.className = `h-3 w-3 rounded-full ${motorColor} transition-all duration-300 ${motorClasses}`;

            // 5. Update Overall System Health
            if (systemInAlarm) {
                elements.systemHealth.textContent = 'ALARM';
                elements.systemHealth.className = 'text-2xl font-bold text-red-400 mt-1';
                elements.healthCard.className = 'status-card bg-red-900/50 p-4 rounded-xl text-center border border-red-500 alarm-pulse';
            } else {
                elements.systemHealth.textContent = 'OK';
                elements.systemHealth.className = 'text-2xl font-bold text-green-400 mt-1';
                elements.healthCard.className = 'status-card bg-gray-700 p-4 rounded-xl text-center';
            }
        }

        // --- Connection / Disconnection Handlers ---
        function onDisconnected(event) {
            isConnected = false;
            log('Device disconnected: ' + event.target.name, true);
            updateConnectionStatus();
            // Clean up characteristic reference
            dataCharacteristic = null; 
        }

        function updateConnectionStatus(status = 'Disconnected', isConnectedStatus = false) {
            connectButton.textContent = isConnectedStatus ? 'Disconnect' : 'Connect to ESP32';
            connectButton.className = `w-full md:w-auto px-6 py-3 font-bold rounded-lg transition-colors duration-200 shadow-md ${isConnectedStatus ? 'bg-red-600 hover:bg-red-700' : 'bg-indigo-600 hover:bg-indigo-700'} text-white`;
            statusText.textContent = status;
            statusText.className = `text-lg font-semibold ${isConnectedStatus ? 'text-green-400' : 'text-red-400'}`;
            statusIcon.className = `inline-block h-4 w-4 rounded-full ${isConnectedStatus ? 'bg-green-500' : 'bg-red-500'}`;
        }

        async function connect() {
            if (isConnected) {
                // Disconnect logic
                if (device && device.gatt.connected) {
                    device.gatt.disconnect();
                }
                return;
            }
            
            // Check for Web Bluetooth API support first
            if (!navigator.bluetooth) {
                log('Web Bluetooth not supported by this browser/OS.', true);
                updateConnectionStatus('Not Supported', false);
                return;
            }


            log('Scanning for BLE device...');
            updateConnectionStatus('Scanning...', false);

            try {
                // 1. Request device - Using both namePrefix and service filter for guaranteed access
                device = await navigator.bluetooth.requestDevice({
                    filters: [
                        { namePrefix: DEVICE_NAME_PREFIX },
                        // Include the service UUID here to ensure permission is granted
                        { services: [SERVICE_UUID] }
                    ],
                    // We still need optionalServices if we access other services, but for a single service,
                    // listing it in filters is usually sufficient and required for permissions.
                    optionalServices: [SERVICE_UUID] 
                });

                device.addEventListener('gattserverdisconnected', onDisconnected);

                log(`Connecting to GATT server of ${device.name}...`);
                updateConnectionStatus('Connecting...', false);

                // 2. Connect to GATT Server
                const server = await device.gatt.connect();

                log('GATT connected. Stabilizing connection (300ms delay)...');
                // ** FIX: Add a small delay to prevent a race condition where the ESP32 disconnects
                // before the browser can retrieve the service map, which causes the error.**
                await new Promise(resolve => setTimeout(resolve, 300));
                
                log('Fetching service...');
                // 3. Get Service (This step should now work as permission was explicitly granted)
                const service = await server.getPrimaryService(SERVICE_UUID);

                log('Service found. Fetching characteristic...');
                // 4. Get Data Characteristic
                dataCharacteristic = await service.getCharacteristic(DATA_CHARACTERISTIC_UUID);
                
                log('Characteristic found. Starting notifications...');
                // 5. Subscribe to Notifications
                await dataCharacteristic.startNotifications();
                dataCharacteristic.addEventListener('characteristicvaluechanged', handleData);
                
                isConnected = true;
                log(`Connected successfully to ${device.name}! Subscribing to data notifications...`);
                updateConnectionStatus('Connected', true);

                // Clear initial log message
                logElement.innerHTML = '';
                log(`[${new Date().toLocaleTimeString()}] Connection established.`);

            } catch (error) {
                // Log the actual error message which clearly indicates the connection state
                log(`BLE Error: ${error.message}`, true); 
                if (error.name !== "NotFoundError") {
                   updateConnectionStatus('Error', false);
                } else {
                   // Scan cancelled or device not found
                   updateConnectionStatus('Scan Failed', false);
                   log('Scan cancelled or device not found.', true);
                }
            }
        }

        // --- Event Listeners ---
        connectButton.addEventListener('click', connect);

        // Initial status update & API check
        document.addEventListener('DOMContentLoaded', () => {
            updateConnectionStatus();
            if (!navigator.bluetooth) {
                connectButton.disabled = true;
                connectButton.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                connectButton.classList.add('bg-gray-500', 'cursor-not-allowed');
                statusText.textContent = 'BLE API Missing';
                log('Web Bluetooth API is required but not found in this environment.', true);
            }
        });

    </script>
</body>
</html>
